<?php $__env->startSection('content'); ?>

<!-- Page Heading/Breadcrumbs -->
<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Create New Project</h1>
        <ol class="breadcrumb">
            <li><a href="/">Home</a></li>
            <li><a href="/account">Account</a></li>
            <li><a href="/account/project">My Projects</a></li>
            <li class="active">Create New Project</li>
        </ol>
    </div>
</div>
<!-- /.row -->

<form method="POST" action="/account/project/add">
	<div class="row">
		<div class="col-md-12">
			<h4>UniDescription Creator</h4>
			<p>
				Need to learn more about best practices for audio descriptions? <a href="/guide" target="_blank">Read our guide</a> for more details!
			</p>
			<p>
				Fill out as many fields on the form below to make your UniDescription app as complete as possible. 
			</p>
		</div>
	</div>
	<!-- /.row -->
	
	<div class="row">
        <div class="col-md-8">
            <h3>Table of Contents - Full Template</h3>
            <ul class="list-group well">
			<?php foreach ($section_templates as $section): ?>
	            <li class="list-group-item">
	                <span class="label label-default pull-right" id="section-<?php echo e($section->id); ?>-label">Not Started</span>
	                <?php if(count($section->children)): ?>
	                	<span class="glyphicon glyphicon-chevron-right toc-arrow" data-toggle="collapse" data-target="#collapse-<?php echo e($section->id); ?>" aria-expanded="false" aria-controls="collapse-<?php echo e($section->id); ?>"></span>
	                <?php endif; ?>
	                
	                <a href="#section-<?php echo e($section->id); ?>"><?php echo e($section->title); ?></a>
	                
	                <?php if(count($section->children)): ?>
	                	<div class="collapse" id="collapse-<?php echo e($section->id); ?>">
					      	<ul class="list-group" style="margin-top: 5px; margin-left: 18px">
							  	<?php foreach($section->children as $child): ?>
						    		<li class="list-group-item">
	    				                <span class="label label-default pull-right" id="section-<?php echo e($child->id); ?>-label">Not Started</span>
						    	  		<a href="#section-<?php echo e($child->id); ?>"><?php echo e($child->title); ?></a>
								  	</li>
								<?php endforeach; ?>
						  	</ul>
						</div>
	                <?php endif; ?>
	            </li>
			<?php endforeach; ?>
            </ul>
        </div>
        <div class="col-md-4">
			<h3>Project Details</h3>
		    <input type="text" id="title" name="title" class="form-control" placeholder="Project Title" value="<?php echo e(old('title')); ?>" required />   
		    <textarea id="description" name="description" class="form-control" placeholder="Description" value="<?php echo e(old('description')); ?>" required></textarea>
		    <p style="margin-top: 10px;">Project progress</p>
			<div class="progress">
				<div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 20%;">
					20%
				</div>
			</div>
		    <!--
		    <div>
            	<hr>
				Select a voice to use.<br />
				<select name="voice" id="choose_voice">
            	</select>
          	</div>
          	-->
          	
        </div>
	</div>
	<!-- /.row -->

        
    <div class="row creator">
        
        <!-- start the paste -->
		<?php foreach ($section_templates as $section): ?>
			<div class="row" id="section-<?php echo e($section->id); ?>">
		        <div class="col-md-6">
		            <div class="row">
			            <div class="col-md-12">
			                <h3><?php echo e($section->title); ?></h3>
			                <p><?php echo e($section->description); ?></p>
			            </div>
		            </div>
		            <div class="form-group has-success">
		            	<label>
		                	Your response:
							<textarea class="form-control" placeholder="<?php echo e($section->description); ?>" style="margin: 0px -1px 0px 0px; width: 464px; height: 173px;" name="" id="section-<?php echo e($section->id); ?>-textarea"></textarea>
						</label>
		            </div>
		            <button type="submit" class="btn btn-default" onclick="playId(this, 'section-<?php echo e($section->id); ?>-textarea')">
		            	<span class="glyphicon glyphicon-play" aria-hidden="true"></span> Play Audio
		            </button>
		            <button type="submit" class="btn btn-default" onclick="downloadId(this, 'section-<?php echo e($section->id); ?>-textarea')">
		            	<span class="glyphicon glyphicon-download" aria-hidden="true"></span> Download Audio
		            </button>
		          
		            <?php if(count($section->children)): ?>
		            	<div style="height: 10px;">&nbsp;</div>
						<?php foreach($section->children as $s): ?>
							<div class="form-group well" id="section-<?php echo e($s->id); ?>">
								<label><?php echo e($s->title); ?></label>
								<textarea class="form-control" style="margin-bottom: 10px;" placeholder="<?php echo e($s->description); ?>" id="section-<?php echo e($s->id); ?>-textarea"></textarea>
								<button type="submit" class="btn btn-default" onclick="playId(this, 'section-<?php echo e($s->id); ?>-textarea')">
									<span class="glyphicon glyphicon-play" aria-hidden="true"></span>Play Audio
								</button>
							</div>
			            <?php endforeach; ?>
			        <?php endif; ?>
		        </div>
		        <div class="col-md-6">
		        	<h3>Standards for <?php echo e($section->title); ?></h3>
		            <p>Click on the subjects below to read more about best practices for audio descriptions.</p>
		            <div class="list-group">
			            <a class="list-group-item disabled" data-toggle="modal" data-target="#whatyouseeModal" style="cursor: pointer">Lorem ipsum dolor site amet</a>
			            <a class="list-group-item disabled">site amet consectetur</a>
			            <a class="list-group-item disabled">Ut lobortis lobortis sodales</a>
			            <a class="list-group-item disabled">Donec dictum ipsum</a>
			            <a class="list-group-item disabled">Nullam at neque</a>
		            </div>
		            <a href="/forum" class="btn btn-default">
		            	<span class="glyphicon glyphicon-user" aria-hidden="true"></span>
						Want to discuss this issue more? Join our forum!
		            </a>
		        </div>
		    </div>
        <?php endforeach; ?>
        <!-- end the paste -->

    </div>
    
	<button class="btn btn-lg btn-primary btn-block" type="submit">Submit Project</button>
</form>

<?php $__env->stopSection(); ?>

<?php $__env->startSection('js'); ?>

<script type="text/javascript">
	
	function downloadId(caller, id)
	{
	    var msg = $('#'+id).val();
	
	    jQuery.ajax({
	        url: 'http://api.montanab.com/tts/tts.php',
	        type: 'get',
	        dataType: 'json',
	        data: 't='+msg,
	        success:function(data)
	        {
	            console.log(data); 
	            window.open(data.fn);
	        } 
	    });
	
	
	}
	
	function playId(caller, id)
	{
	    if ( $('span', caller).attr('class') == 'glyphicon glyphicon-play') {
	        $(caller).html('<span class="glyphicon glyphicon-stop" aria-hidden="true"></span>Stop Audio');
	        var msg = new SpeechSynthesisUtterance( $('#'+id).val() );
	        var voices = speechSynthesis.getVoices();
	        msg.voice = voices[ $('#choose_voice').val() ];
			console.log( $('#choose_voice').val() );
	        //window.speechSynthesis.speak(msg);
	        speechUtteranceChunker(msg, {
	            chunkLength: 120
	        }, function () {
	            //some code to execute when done
	            console.log('done');
	        });
	    }
	    else {
	        $(caller).html('<span class="glyphicon glyphicon-play" aria-hidden="true"></span>Play Audio');
	        speechSynthesis.cancel();
	    }
	}
	
	var speechUtteranceChunker = function (utt, settings, callback) {
	    settings = settings || {};
	    var newUtt;
	    var txt = (settings && settings.offset !== undefined ? utt.text.substring(settings.offset) : utt.text);
	    if (utt.voice && utt.voice.voiceURI === 'native') { // Not part of the spec
	        newUtt = utt;
	        newUtt.text = txt;
	        newUtt.addEventListener('end', function () {
	            if (speechUtteranceChunker.cancel) {
	                speechUtteranceChunker.cancel = false;
	            }
	            if (callback !== undefined) {
	                callback();
	            }
	        });
	    }
	    else {
	        var chunkLength = (settings && settings.chunkLength) || 160;
	        var pattRegex = new RegExp('^[\\s\\S]{' + Math.floor(chunkLength / 2) + ',' + chunkLength + '}[.!?,]{1}|^[\\s\\S]{1,' + chunkLength + '}$|^[\\s\\S]{1,' + chunkLength + '} ');
	        var chunkArr = txt.match(pattRegex);
	
	        if (chunkArr[0] === undefined || chunkArr[0].length <= 2) {
	            //call once all text has been spoken...
	            if (callback !== undefined) {
	                callback();
	            }
	            return;
	        }
	        var chunk = chunkArr[0];
	        newUtt = new SpeechSynthesisUtterance(chunk);
	        var x;
	        for (x in utt) {
	            if (utt.hasOwnProperty(x) && x !== 'text') {
	                newUtt[x] = utt[x];
	            }
	        }
	        newUtt.addEventListener('end', function () {
	            if (speechUtteranceChunker.cancel) {
	                speechUtteranceChunker.cancel = false;
	                return;
	            }
	            settings.offset = settings.offset || 0;
	            settings.offset += chunk.length - 1;
	            speechUtteranceChunker(utt, settings, callback);
	        });
	    }
	
	    if (settings.modifier) {
	        settings.modifier(newUtt);
	    }
	    console.log(newUtt); //IMPORTANT!! Do not remove: Logging the object out fixes some onend firing issues.
	    //placing the speak invocation inside a callback fixes ordering and onend issues.
	    setTimeout(function () {
	        var voices = speechSynthesis.getVoices();
	        newUtt.voice = voices[ $('#choose_voice').val() ];
	        speechSynthesis.speak(newUtt);
	    }, 0);
	};
	
	$(document).ready(function() {
		$('.toc-arrow').on('click', function() {
	    	$(this).toggleClass('glyphicon-chevron-right').toggleClass('glyphicon-chevron-down');
	  	});
	  	
	  	$('.dropdown-menu').dropdown();
	  	
	    if ('speechSynthesis' in window) {
	        // Supported
	        window.speechSynthesis.onvoiceschanged = function() {
	                var voices = window.speechSynthesis.getVoices();
	                if ($('#choose_voice option').size() < 1) {
	                    //console.log(voices);
	                    for (i = 0, len = voices.length; i < len; i++) {
	                        $('#choose_voice')
	                                .append($("<option></option>")
	                                .attr("value",i)
	                                .text(voices[i]['name'])); 
	                    }
	                    $('#choose_voice').val(0);
	                }
	
	        };
	    }
	    else {
	        alert('Speech Systhesis not supported in your browser. Use Chrome for the prototype');
	    }
	    
	    // Take the nav bar into account
	    $(window).on("hashchange", function () {
		    window.scrollTo(window.scrollX, window.scrollY - 60);
		});
		
		$('textarea', $('div.creator')).keyup(function(event) {
			var label_match = $(event.currentTarget).attr('id').match(/(\d+)/);
			var section_id = label_match[0];
			var length = $(event.currentTarget).val().length;
			var section_label = $('span#section-'+section_id+'-label');
			
			$(section_label).removeClass('label-default label-primary label-success label-info label-warning label-danger');
			
			var new_label_class = '';
			if (length == 0) {
				new_label_class = 'label-default';
				new_label_text = 'Not Started';
			}
			else if (length <= 20) {
				new_label_class = 'label-danger';
				new_label_text = 'Not Enough Text';
			}
			else if (length <= 100) {
				new_label_class = 'label-warning';
				new_label_text = 'Text Seems Short';
			}
			else if (length <= 300) {
				new_label_class = 'label-info';
				new_label_text = 'Good Text Length';
			}
			else {
				new_label_class = 'label-success';
				new_label_text = 'Great Text Length';
			}
			
			$(section_label).addClass(new_label_class);
			$(section_label).html(new_label_text)

		});
	    
	});



</script>

<?php $__env->stopSection(); ?>
<?php echo $__env->make('layouts.app', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>